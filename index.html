<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Jurnal 7A Pro</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#BB86FC">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-body: #121212; --bg-card: #1E1E1E; --bg-input: #2C2C2C;
            --border: #333333; --text-main: #E0E0E0; --text-muted: #A0A0A0;
            --primary: #BB86FC; --accent: #03DAC6; --danger: #CF6679;
            --warning: #FFAB00; --success: #00C853; --info: #2979FF;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; padding: 0; font-family: 'Inter', sans-serif; background: var(--bg-body); color: var(--text-main); padding-bottom: 85px; }

        /* HEADER */
        .header { background: var(--bg-card); padding: 15px 20px; border-bottom: 1px solid var(--border); position: sticky; top: 0; z-index: 50; display: flex; justify-content: space-between; align-items: center; }
        .header h2 { margin: 0; font-size: 1.1em; }
        .header p { margin: 0; font-size: 0.7em; color: var(--text-muted); }

        /* SECTIONS */
        .section { display: none; padding: 15px; animation: fadeIn 0.3s; }
        .section.active { display: block; }
        .card { background: var(--bg-card); padding: 15px; border-radius: 12px; border: 1px solid var(--border); margin-bottom: 15px; position: relative; }

        /* INPUTS & BUTTONS */
        label { display: block; font-size: 0.85em; color: var(--text-muted); margin-bottom: 6px; font-weight: 600; }
        input, select, textarea { width: 100%; padding: 12px; background: var(--bg-input); border: 1px solid var(--border); border-radius: 8px; color: white; font-family: inherit; font-size: 14px; }
        .btn { width: 100%; padding: 12px; border: none; border-radius: 8px; font-weight: 700; cursor: pointer; margin-top: 10px; }
        .btn-primary { background: var(--primary); color: #000; }
        .btn-success { background: var(--success); color: #000; }
        .btn-danger { background: var(--danger); color: #fff; }
        .btn-outline { background: transparent; border: 1px solid var(--text-muted); color: var(--text-muted); }

        /* DASHBOARD */
        .dashboard-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
        .stat-box { background: var(--bg-input); padding: 15px; border-radius: 10px; text-align: center; }
        .stat-val { font-size: 1.5em; font-weight: bold; display: block; }
        .stat-lbl { font-size: 0.7em; text-transform: uppercase; color: var(--text-muted); }
        .today-list { list-style: none; padding: 0; margin: 0; }
        .today-item { padding: 10px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .badge { padding: 3px 8px; border-radius: 4px; font-size: 0.7em; font-weight: bold; color: #000; }

        /* ABSENSI & LISTS */
        .search-bar { margin-bottom: 15px; }
        .absen-row { padding: 12px 0; border-bottom: 1px solid var(--border); display: flex; flex-direction: column; gap: 8px; }
        .absen-top { display: flex; justify-content: space-between; align-items: center; }
        .absen-opts { display: flex; gap: 5px; }
        
        input[type="radio"] { display: none; }
        .opt-lbl { width: 32px; height: 32px; border-radius: 6px; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 0.8em; background: #2A2A2A; color: #555; cursor: pointer; border: 1px solid #333; }
        input[value="S"]:checked + .opt-lbl { background: var(--primary); color: black; }
        input[value="I"]:checked + .opt-lbl { background: var(--warning); color: black; }
        input[value="A"]:checked + .opt-lbl { background: var(--danger); color: white; }

        /* REPORT TABLE */
        .recap-table { width: 100%; border-collapse: collapse; font-size: 0.8em; }
        .recap-table th { text-align: left; color: var(--text-muted); padding: 8px 4px; border-bottom: 1px solid var(--border); }
        .recap-table td { padding: 8px 4px; border-bottom: 1px solid #333; }
        .col-num { width: 35px; text-align: center; font-weight: bold; }
        .zero-val { color: #444; font-weight: normal; }

        /* BOTTOM NAV */
        .bottom-nav { position: fixed; bottom: 0; width: 100%; background: var(--bg-card); border-top: 1px solid var(--border); display: flex; justify-content: space-around; padding: 10px 0; z-index: 100; }
        .nav-item { text-align: center; color: var(--text-muted); font-size: 0.7em; width: 20%; }
        .nav-item.active { color: var(--accent); font-weight: bold; }
        .nav-icon { font-size: 1.4em; display: block; margin-bottom: 3px; }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>

    <div class="header">
        <div>
            <h2>7A Admin</h2>
            <p id="current-date">...</p>
        </div>
        <div onclick="initApp()" style="font-size:1.2em; cursor:pointer;">üîÑ</div>
    </div>

    <div id="view-home" class="section active">
        <div class="card" style="border-left: 5px solid var(--accent);">
            <h3 style="margin-top:0; color:var(--text-main);">Log Harian</h3>
            <div id="today-summary"></div>
            <div style="margin-top:10px;">
                <button class="btn btn-primary" style="margin:0; font-size:0.8em; width:auto;" onclick="nav('absen', document.querySelectorAll('.nav-item')[1])">üìù Isi Absen</button>
            </div>
        </div>

        <div class="dashboard-grid">
            <div class="stat-box"><span class="stat-val" id="today-sakit" style="color:var(--primary)">0</span><span class="stat-lbl">Sakit (Hari Ini)</span></div>
            <div class="stat-box"><span class="stat-val" id="today-izin" style="color:var(--warning)">0</span><span class="stat-lbl">Izin (Hari Ini)</span></div>
            <div class="stat-box"><span class="stat-val" id="today-alpha" style="color:var(--danger)">0</span><span class="stat-lbl">Alpha (Hari Ini)</span></div>
            <div class="stat-box"><span class="stat-val" id="today-kasus" style="color:white">0</span><span class="stat-lbl">Kasus (Hari Ini)</span></div>
        </div>

        <div class="card" style="border-left: 5px solid var(--info); margin-top: 15px;">
            <h3 style="margin-top:0;">üìÖ Jadwal Panggil</h3>
            <ul id="schedule-container" class="today-list"></ul>
        </div>
    </div>

    <div id="view-absen" class="section">
        <div class="card">
            <label>Tanggal</label>
            <input type="date" id="absen-tgl">
        </div>
        <div class="search-bar">
            <input type="text" id="search-absen" placeholder="üîç Cari nama siswa..." onkeyup="filterAbsen()">
        </div>
        <div class="card" style="padding: 0 15px;">
            <div id="list-absen-container"></div>
        </div>
        <button class="btn btn-primary" onclick="simpanAbsen()">üíæ Simpan Absensi</button>
    </div>

    <div id="view-kasus" class="section">
        <div class="card">
            <label>Siswa</label>
            <select id="kasus-nama"><option value="">-- Pilih --</option></select>
            <label style="margin-top:10px;">Tanggal Kejadian</label>
            <input type="date" id="kasus-tgl">
            <label style="margin-top:10px;">Kategori</label>
            <select id="kasus-kat">
                <option value="Ringan">üü¢ Ringan (Atribut/Terlambat)</option>
                <option value="Sedang">üü† Sedang (Bolos/Gaduh)</option>
                <option value="Berat">üî¥ Berat (Narkoba/Bullying)</option>
            </select>
            <div style="background:var(--bg-input); padding:10px; border-radius:8px; margin-top:15px; border:1px solid var(--info);">
                <label style="color:var(--info);">üìÖ Target Panggil (Opsional)</label>
                <input type="date" id="kasus-deadline" style="border-color:var(--info);">
            </div>
            <label style="margin-top:15px;">Kronologi</label>
            <textarea id="kasus-ket" rows="3"></textarea>
            <button class="btn btn-danger" onclick="simpanKasus()">‚ö†Ô∏è Catat Kasus</button>
        </div>
    </div>

    <div id="view-laporan" class="section">
         <div class="card">
            <h3 style="margin-top:0;">Rekapitulasi Data</h3>
            
            <div style="margin-bottom: 10px;">
                <label>Filter Nama Siswa:</label>
                <select id="filter-nama" onchange="renderRekap(); renderLog();" style="border: 1px solid var(--accent);">
                    <option value="">-- Tampilkan Semua Siswa --</option>
                </select>
            </div>

            <div style="display:flex; gap:10px; margin-bottom:15px; background:var(--bg-input); padding:10px; border-radius:8px;">
                <div style="flex:1;">
                    <label>Mode:</label>
                    <select id="filter-mode" onchange="toggleFilterMode()">
                        <option value="bulan">üóìÔ∏è Bulanan</option>
                        <option value="semester">üìö Semester</option>
                    </select>
                </div>
                <div style="flex:1;" id="div-filter-bulan">
                    <label>Bulan:</label>
                    <input type="month" id="filter-bulan" onchange="renderRekap(); renderLog();">
                </div>
            </div>

            <div style="overflow-x:auto;">
                <table class="recap-table">
                    <thead>
                        <tr>
                            <th style="width:20px;">No</th>
                            <th>Nama</th>
                            <th class="col-num">S</th>
                            <th class="col-num">I</th>
                            <th class="col-num">A</th>
                            <th class="col-num">K</th>
                        </tr>
                    </thead>
                    <tbody id="rekap-body"></tbody>
                </table>
            </div>
            <div style="margin-top:15px; text-align:right;">
                <button class="btn btn-success" style="width:auto; font-size:0.8em;" onclick="downloadCSV()">‚¨á Excel (Format Rapi)</button>
            </div>
        </div>

        <div class="card">
            <h3 style="margin-top:0;">Log & Rincian Kasus</h3>
            <p style="font-size: 0.7em; color: var(--text-muted); margin-bottom: 10px;">Detail Absensi & Kasus akan muncul di sini sesuai filter.</p>
            <div style="overflow-x:auto; max-height: 350px;">
                <table class="recap-table" id="log-table"></table>
            </div>
        </div>
    </div>

    <div id="view-settings" class="section">
        <div class="card">
            <h3 style="margin-top:0;">Kelola Siswa</h3>
            <div style="display:flex; gap:10px;">
                <input type="text" id="new-student-name" placeholder="Nama Siswa Baru">
                <button class="btn btn-primary" style="width:auto; margin:0;" onclick="addStudent()">+</button>
            </div>
        </div>
        <div class="card" style="border-color: var(--accent);">
            <h3 style="margin-top:0; color:var(--accent);">Backup & Restore</h3>
            <button class="btn btn-outline" onclick="backupData()">‚¨á Backup Data</button>
            <div style="margin-top:10px; border-top:1px solid #333; padding-top:10px;">
                <label>Restore File:</label>
                <input type="file" id="file-restore" accept=".json" onchange="restoreData(this)">
            </div>
        </div>
        <button class="btn btn-danger" onclick="resetAllData()">üóëÔ∏è RESET SEMUA DATA</button>
    </div>

    <div class="bottom-nav">
        <div class="nav-item active" onclick="nav('home', this)"><span class="nav-icon">üìä</span>Home</div>
        <div class="nav-item" onclick="nav('absen', this)"><span class="nav-icon">üìù</span>Absen</div>
        <div class="nav-item" onclick="nav('kasus', this)"><span class="nav-icon">‚ö†Ô∏è</span>Kasus</div>
        <div class="nav-item" onclick="nav('laporan', this)"><span class="nav-icon">üìë</span>Laporan</div>
        <div class="nav-item" onclick="nav('settings', this)"><span class="nav-icon">‚öôÔ∏è</span>Setelan</div>
    </div>

<script>
    const defaultSiswa = [
        "Abbas Al Hilaly", "Akcmad Al Fachri", "Al Fath Rizqie Ramadhan", "Alvino Nazulia Pratama", 
        "Arrahman Zahir Ramadhan", "Azka Tsabitah Akmal", "Azka Zaidan Abdu Ghani", "Daffa Chandra Putra", 
        "Farhan Azmirrohman", "Fauzan Indra Tama", "Fitrah Satriaji Wahyudi", "Ikhsanul Aziz", 
        "Ilham Daffa Syaputra", "Muhamad Ibnu Galih Saifani", "Muhamad Ilham Dwi Saputra", "Muhammad Altaf Naufal", 
        "Muhammad Azka Mubarak", "Muhammad Firdaus", "Muhammad Ilram Nurfikriy", "Muhammad Restu Azriel Setiawan", 
        "Muhammad Reyvan Bachri Putra", "Muhammad Rifqy", "Muhammad Widad Fhasando", "Muhammad Zidan Sangsaka Ramadhani", 
        "Rakha Hanif Arryyan", "Revan Maulana Yusuf", "Wizra Rais Adlan", "Yusuf Nur Suriya Hadi", 
        "Zaidan Alfathizi Prasetya", "M. Harun Arrosyid"
    ];

    let siswaList = JSON.parse(localStorage.getItem('db_siswa_7a')) || defaultSiswa;

    document.addEventListener('DOMContentLoaded', () => {
        setupDate();
        initApp();
        if ('serviceWorker' in navigator) { navigator.serviceWorker.register('./sw.js'); }
    });

    function setupDate() {
        const today = new Date().toISOString().split('T')[0];
        if(document.getElementById('absen-tgl')) document.getElementById('absen-tgl').value = today;
        if(document.getElementById('kasus-tgl')) document.getElementById('kasus-tgl').value = today;
        if(document.getElementById('filter-bulan')) document.getElementById('filter-bulan').value = today.slice(0, 7);
        
        const opts = { weekday: 'long', day: 'numeric', month: 'short' };
        document.getElementById('current-date').innerText = new Date().toLocaleDateString('id-ID', opts);
    }

    function initApp() {
        renderAbsenList();
        renderDropdown();
        updateDashboard();
        renderRekap();
        renderLog();
    }

    // --- DASHBOARD ---
    function updateDashboard() {
        const absen = JSON.parse(localStorage.getItem('db_absen')) || [];
        const kasus = JSON.parse(localStorage.getItem('db_kasus')) || [];
        const today = new Date().toISOString().split('T')[0];
        const todayAbsen = absen.filter(x => x.date === today);
        const todayKasus = kasus.filter(x => x.date === today);

        document.getElementById('today-sakit').innerText = todayAbsen.filter(x => x.type === 'S').length;
        document.getElementById('today-izin').innerText = todayAbsen.filter(x => x.type === 'I').length;
        document.getElementById('today-alpha').innerText = todayAbsen.filter(x => x.type === 'A').length;
        document.getElementById('today-kasus').innerText = todayKasus.length;

        const listDiv = document.getElementById('today-summary');
        if(todayAbsen.length === 0 && todayKasus.length === 0) {
            listDiv.innerHTML = '<p style="text-align:center; color:#00C853; font-weight:bold; font-size:0.9em;">Belum ada data masuk hari ini.</p>';
        } else {
            let html = '<ul class="today-list">';
            todayAbsen.forEach(x => {
                let color = x.type === 'S' ? '#BB86FC' : (x.type === 'I' ? '#FFAB00' : '#CF6679');
                html += `<li class="today-item"><span>${x.name} <br><small style="color:#888">${x.desc}</small></span><span class="badge" style="background:${color}">${x.type}</span></li>`;
            });
            todayKasus.forEach(x => {
                html += `<li class="today-item"><span>${x.name} <br><small style="color:#888">${x.cat}</small></span><span class="badge" style="background:#fff; color:#000">KASUS</span></li>`;
            });
            html += '</ul>';
            listDiv.innerHTML = html;
        }

        const scheduleUl = document.getElementById('schedule-container');
        scheduleUl.innerHTML = '';
        const jadwal = kasus.filter(x => x.deadline && x.deadline !== "").sort((a,b) => new Date(a.deadline) - new Date(b.deadline));
        if(jadwal.length > 0) {
            jadwal.forEach(x => {
                const d = new Date(x.deadline);
                const tglStr = d.getDate() + '/' + (d.getMonth()+1);
                scheduleUl.innerHTML += `<li class="today-item" style="border-left:3px solid var(--info); padding-left:10px;"><div><span style="font-weight:bold; display:block;">${x.name}</span><small style="color:#888;">Kasus: ${x.cat}</small></div><div style="text-align:right;"><span class="badge" style="background:var(--info); color:white;">${tglStr}</span></div></li>`;
            });
        } else {
            scheduleUl.innerHTML = '<li style="text-align:center; padding:10px; color:#666; font-size:0.8em;">Tidak ada jadwal panggil.</li>';
        }
    }

    // --- ABSEN ---
    function renderAbsenList() {
        const container = document.getElementById('list-absen-container');
        if(!container) return;
        container.innerHTML = '';
        siswaList.sort().forEach((nama, i) => {
            container.innerHTML += `
            <div class="absen-row" data-name="${nama.toLowerCase()}">
                <div class="absen-top">
                    <span style="font-size:0.9em;">${i+1}. ${nama}</span>
                    <div class="absen-opts">
                        <input type="radio" name="abs_${i}" value="H" checked id="h_${i}" onchange="toggleKet(${i})">
                        <label><input type="radio" name="abs_${i}" value="S" onchange="toggleKet(${i})"><span class="opt-lbl">S</span></label>
                        <label><input type="radio" name="abs_${i}" value="I" onchange="toggleKet(${i})"><span class="opt-lbl">I</span></label>
                        <label><input type="radio" name="abs_${i}" value="A" onchange="toggleKet(${i})"><span class="opt-lbl">A</span></label>
                    </div>
                </div>
                <input type="text" id="ket_${i}" placeholder="Keterangan..." style="display:none; padding:8px; font-size:0.8em; margin-top:5px;">
            </div>`;
        });
    }

    window.toggleKet = function(i) {
        const val = document.querySelector(`input[name="abs_${i}"]:checked`).value;
        const input = document.getElementById(`ket_${i}`);
        input.style.display = (val === 'H') ? 'none' : 'block';
        if(val === 'H') input.value = '';
    }

    window.filterAbsen = function() {
        const term = document.getElementById('search-absen').value.toLowerCase();
        document.querySelectorAll('.absen-row').forEach(row => { row.style.display = row.dataset.name.includes(term) ? 'flex' : 'none'; });
    }

    window.simpanAbsen = function() {
        const tgl = document.getElementById('absen-tgl').value;
        let db = JSON.parse(localStorage.getItem('db_absen')) || [];
        let count = 0;
        siswaList.forEach((nama, i) => {
            const status = document.querySelector(`input[name="abs_${i}"]:checked`).value;
            const ket = document.getElementById(`ket_${i}`).value;
            if(status !== 'H') {
                db.push({ id: Date.now()+i, date: tgl, name: nama, type: status, desc: ket });
                count++;
            }
        });
        localStorage.setItem('db_absen', JSON.stringify(db));
        alert(count + " Data tersimpan.");
        renderAbsenList(); updateDashboard(); renderRekap(); renderLog();
    }

    function renderDropdown() {
        const sel = document.getElementById('kasus-nama');
        if(sel) {
            sel.innerHTML = '<option value="">-- Pilih Siswa --</option>';
            siswaList.forEach(s => sel.innerHTML += `<option value="${s}">${s}</option>`);
        }
        const selFilter = document.getElementById('filter-nama');
        if(selFilter) {
            selFilter.innerHTML = '<option value="">-- Tampilkan Semua Siswa --</option>';
            siswaList.sort().forEach(s => selFilter.innerHTML += `<option value="${s}">${s}</option>`);
        }
    }

    window.simpanKasus = function() {
        const n = document.getElementById('kasus-nama').value;
        const d = document.getElementById('kasus-tgl').value;
        const k = document.getElementById('kasus-kat').value;
        const ket = document.getElementById('kasus-ket').value;
        const deadline = document.getElementById('kasus-deadline').value;
        if(!n || !ket) return alert("Lengkapi data!");
        let db = JSON.parse(localStorage.getItem('db_kasus')) || [];
        db.push({ id: Date.now(), date: d, name: n, type: 'KASUS', cat: k, desc: ket, deadline: deadline });
        localStorage.setItem('db_kasus', JSON.stringify(db));
        alert("Kasus dicatat.");
        document.getElementById('kasus-ket').value = '';
        document.getElementById('kasus-deadline').value = '';
        updateDashboard(); renderRekap(); renderLog();
    }

    // --- REKAP & LOG ---
    window.toggleFilterMode = function() {
        const mode = document.getElementById('filter-mode').value;
        const divBulan = document.getElementById('div-filter-bulan');
        const btn = document.querySelector('#view-laporan .btn-success');
        divBulan.style.display = (mode === 'semester') ? 'none' : 'block';
        btn.innerText = (mode === 'semester') ? "‚¨á Excel (Rekap Semester)" : "‚¨á Excel (Laporan Bulanan)";
        renderRekap(); renderLog();
    }

    window.renderRekap = function() {
        const mode = document.getElementById('filter-mode').value;
        const bulan = document.getElementById('filter-bulan').value;
        const selectedName = document.getElementById('filter-nama').value;
        const absen = JSON.parse(localStorage.getItem('db_absen')) || [];
        const kasus = JSON.parse(localStorage.getItem('db_kasus')) || [];
        const tbody = document.getElementById('rekap-body');
        tbody.innerHTML = '';

        siswaList.sort().forEach((nama, idx) => {
            if(selectedName && nama !== selectedName) return;
            let myAbsen = absen.filter(x => x.name === nama);
            let myKasus = kasus.filter(x => x.name === nama);
            if(mode === 'bulan') {
                myAbsen = myAbsen.filter(x => x.date.startsWith(bulan));
                myKasus = myKasus.filter(x => x.date.startsWith(bulan));
            }
            const s = myAbsen.filter(x => x.type === 'S').length;
            const i = myAbsen.filter(x => x.type === 'I').length;
            const a = myAbsen.filter(x => x.type === 'A').length;
            const k = myKasus.length;
            
            const sStyle = s > 0 ? 'color:var(--primary)' : 'class="zero-val"';
            const iStyle = i > 0 ? 'color:var(--warning)' : 'class="zero-val"';
            const aStyle = a > 0 ? 'color:var(--danger)' : 'class="zero-val"';
            const kStyle = k > 0 ? 'color:#fff; font-weight:bold;' : 'class="zero-val"';

            tbody.innerHTML += `<tr><td style="color:#666;">${idx+1}</td><td>${nama}</td><td class="col-num" ${sStyle}>${s}</td><td class="col-num" ${iStyle}>${i}</td><td class="col-num" ${aStyle}>${a}</td><td class="col-num" ${kStyle}>${k}</td></tr>`;
        });
    }

    function renderLog() {
        const absen = JSON.parse(localStorage.getItem('db_absen')) || [];
        const kasus = JSON.parse(localStorage.getItem('db_kasus')) || [];
        const selectedName = document.getElementById('filter-nama').value;
        const mode = document.getElementById('filter-mode').value;
        const bulan = document.getElementById('filter-bulan').value;
        
        let all = [...absen, ...kasus].sort((a,b) => new Date(b.date) - new Date(a.date));
        if (selectedName) all = all.filter(x => x.name === selectedName);
        if(mode === 'bulan') all = all.filter(x => x.date.startsWith(bulan));

        const table = document.getElementById('log-table');
        table.innerHTML = '';
        if(all.length === 0) {
            table.innerHTML = '<tr><td colspan="4" style="text-align:center; padding:15px; color:#666;">Tidak ada data sesuai filter.</td></tr>';
            return;
        }
        all.forEach(x => {
            let label = x.type === 'KASUS' ? '‚ö†Ô∏è' : x.type;
            let extra = x.deadline ? `<br><small style="color:var(--info)">Target: ${x.deadline}</small>` : '';
            let detailKet = x.desc ? x.desc : (x.cat ? x.cat : '-');
            table.innerHTML += `<tr>
                <td style="width:75px; font-size:0.7em; color:#888; vertical-align:top;">${x.date}</td>
                <td style="vertical-align:top;"><span style="font-weight:bold; font-size:0.9em;">${x.name}</span><br><span style="font-size:0.8em; color:#bbb;">Ket: ${detailKet}</span>${extra}</td>
                <td style="text-align:right; font-weight:bold; vertical-align:top;">${label}</td>
                <td style="width:30px; text-align:center; vertical-align:top;"><span onclick="delItem(${x.id}, '${x.type}')" style="color:red; cursor:pointer;">√ó</span></td>
            </tr>`;
        });
    }

    window.delItem = function(id, type) {
        if(!confirm("Hapus?")) return;
        let key = type === 'KASUS' ? 'db_kasus' : 'db_absen';
        let db = JSON.parse(localStorage.getItem(key)) || [];
        db = db.filter(x => x.id !== id);
        localStorage.setItem(key, JSON.stringify(db));
        renderLog(); renderRekap(); updateDashboard();
    }

    // --- CSV EXPORT FIX (EXCEL FRIENDLY) ---
    window.downloadCSV = function() {
        const mode = document.getElementById('filter-mode').value;
        const bulan = document.getElementById('filter-bulan').value;
        const absen = JSON.parse(localStorage.getItem('db_absen')) || [];
        const kasus = JSON.parse(localStorage.getItem('db_kasus')) || [];
        
        // Header pakai titik koma
        let csvContent = "NO;NAMA;SAKIT;IZIN;ALPHA;KASUS\n";
        
        siswaList.sort().forEach((nama, idx) => {
            let myAbsen = absen.filter(x => x.name === nama);
            let myKasus = kasus.filter(x => x.name === nama);

            if(mode === 'bulan') {
                myAbsen = myAbsen.filter(x => x.date.startsWith(bulan));
                myKasus = myKasus.filter(x => x.date.startsWith(bulan));
            }

            const s = myAbsen.filter(x => x.type === 'S').length;
            const i = myAbsen.filter(x => x.type === 'I').length;
            const a = myAbsen.filter(x => x.type === 'A').length;
            const k = myKasus.length;

            // Baris data pakai titik koma dan kutip
            csvContent += `${idx+1};"${nama}";${s};${i};${a};${k}\n`;
        });

        // Pakai BOM (\uFEFF) supaya Excel otomatis detect UTF-8 (tidak berantakan)
        const blob = new Blob(["\ufeff" + csvContent], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement("a");
        link.setAttribute("href", url);
        link.setAttribute("download", "Rekap_Data_Siswa.csv");
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    // --- SYSTEM ---
    window.addStudent = function() {
        const name = document.getElementById('new-student-name').value;
        if(!name) return;
        siswaList.push(name); siswaList.sort();
        localStorage.setItem('db_siswa_7a', JSON.stringify(siswaList));
        alert("Siswa ditambahkan."); location.reload();
    }
    window.backupData = function() {
        const data = { siswa: JSON.parse(localStorage.getItem('db_siswa_7a')), absen: JSON.parse(localStorage.getItem('db_absen')), kasus: JSON.parse(localStorage.getItem('db_kasus')) };
        const blob = new Blob([JSON.stringify(data)], {type: "application/json"});
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = "BACKUP_7A_" + new Date().toISOString().split('T')[0] + ".json"; a.click();
    }
    window.restoreData = function(input) {
        const file = input.files[0]; if(!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const data = JSON.parse(e.target.result);
                if(data.siswa) localStorage.setItem('db_siswa_7a', JSON.stringify(data.siswa));
                if(data.absen) localStorage.setItem('db_absen', JSON.stringify(data.absen));
                if(data.kasus) localStorage.setItem('db_kasus', JSON.stringify(data.kasus));
                alert("Data berhasil dikembalikan!"); location.reload();
            } catch(err) { alert("File rusak."); }
        }; reader.readAsText(file);
    }
    window.resetAllData = function() {
        if(prompt("Ketik RESET untuk hapus data semester ini:") === "RESET") {
            localStorage.removeItem('db_absen'); localStorage.removeItem('db_kasus');
            alert("Bersih!"); location.reload();
        }
    }
    window.nav = function(id, el) {
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        document.getElementById('view-'+id).classList.add('active');
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        el.classList.add('active');
        if(id === 'home') updateDashboard();
        if(id === 'laporan') { renderRekap(); renderLog(); }
    }
</script>
</body>
</html>
